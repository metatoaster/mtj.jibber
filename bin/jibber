#!/bin/python

import code
import json
import logging
import sys

try:
    import readline
except ImportError:
    pass

from mtj.jibber.jabber import MucChatBot

# Python versions before 3.0 do not use UTF-8 encoding
# by default. To ensure that Unicode is handled properly
# throughout SleekXMPP, we will set the default encoding
# ourselves to UTF-8.
if sys.version_info < (3, 0):
    from sleekxmpp.util.misc_ops import setdefaultencoding
    setdefaultencoding('utf8')
else:
    raw_input = input

logging.basicConfig(level='INFO',
                    format='%(asctime)s %(levelname)s %(name)s %(message)s')

logger = logging.getLogger('jibber')

bot = MucChatBot()

argv = list(reversed(sys.argv[1:]))
if not argv:
    print('Usage: %s <server_config_json> [<client_config_json>]' % __file__)
    sys.exit(1)

server_f = argv.pop()
with open(server_f) as fd:
    s_config = fd.read()

if argv:
    client_f = argv.pop()
    with open(client_f) as fd:
        c_config = fd.read()
else:
    c_config = None

bot.load_server_config(s_config)
if c_config:
    bot.load_client_config(c_config)

console = code.InteractiveConsole(locals={
    b'bot': bot,
})
result = console.interact(
    'Starting interactive shell; `bot` is bound to the MucBot object.\n'
    'Try calling bot.connect() to connect.')

# Try to disconnect on exit anyway.
bot.disconnect()
